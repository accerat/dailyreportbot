
import { createServer } from 'http'; import { URL } from 'url';
export function startKeepAlive(client){ const SECRET=process.env.UPTIME_SECRET; const s=createServer(async(req,res)=>{ try{ const url=new URL(req.url||'/','http://localhost'); const p=url.pathname; if(SECRET&&(p==='/health'||p==='/')){ res.statusCode=404; res.end('not found'); return; } if(p==='/health'||(SECRET&&p===`/health/${SECRET}`)||p==='/'){ const status=client?.ws?.status??'unknown'; const ping=client?.ws?.ping??null; const guilds=client?.guilds?.cache?.size??0; res.setHeader('Content-Type','application/json'); res.end(JSON.stringify({ok:true, ws_status:status, ping_ms:ping, guilds})); return;} if(p==='/metrics'){ const status=client?.ws?.status??'unknown'; const ping=client?.ws?.ping??'NaN'; const guilds=client?.guilds?.cache?.size??0; res.setHeader('Content-Type','text/plain'); res.end(`ws_status=${status} ping_ms=${ping} guilds=${guilds}`); return;} res.statusCode=404; res.end('not found'); }catch{ res.statusCode=500; res.end('error'); } }); return s; }
